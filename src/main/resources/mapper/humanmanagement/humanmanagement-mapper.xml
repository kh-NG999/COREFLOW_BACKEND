<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="member">

	<!-- 부모 부서 조회 -->
	<select id="deptList" resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$Department">
		SELECT *
		FROM DEPARTMENT
		WHERE PARENT_ID IS NULL
	</select>
	
	<!-- 자식 부서 조회 -->
	<select id="deptDetailList" resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$Department">
		SELECT *
		FROM DEPARTMENT
		WHERE PARENT_ID = #{parentId}
	</select>
	
	<!-- 부서 코드 조회 -->
	<select id="findDepId" resultType="java.lang.Integer">
		SELECT DEP_ID
		FROM DEPARTMENT
		WHERE DEP_NAME = #{depName}
	</select>
	
	<!-- 직위 조회 -->
	<select id="posiList" resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$Position">
		SELECT *
		FROM POSITIONS
		ORDER BY POS_ID ASC
	</select>
	
	<!-- 직위코드 조회 -->
	<select id="findPodId" resultType="int">
		SELECT POS_ID
		FROM POSITIONS
		WHERE POS_NAME = #{posName}
	</select>
	
	<!-- 사원 조회 -->
	<select id="memberList" resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$MemberResponse">
		SELECT
			USER_NO,
			USER_NAME,
			EMAIL,
			HIRE_DATE,
			PHONE,
			EXTENSION,
			ADDRESS,
			ADDRESS_DETAIL,
			UPDATE_DATE,
			DEP_NAME,
			POS_NAME,
			STATUS
		FROM MEMBER
		LEFT JOIN DEPARTMENT USING(DEP_ID)
		LEFT JOIN POSITIONS USING(POS_ID)
		<where>
			<if test="status != null and status != ''">
				STATUS = #{status}
			</if>
			<if test="userName != null and userName != ''">
				AND USER_NAME LIKE '%' || #{userName} || '%'
			</if>
			<if test="depName != null and depName != ''">
	            AND DEP_ID IN (
	                SELECT DEP_ID
	                FROM DEPARTMENT
	                START WITH DEP_NAME = #{depName}
	                CONNECT BY PRIOR DEP_ID = PARENT_ID
	            )
	        </if>
			<if test="posName != null and posName != ''">
				AND POS_NAME = #{posName}
			</if>
		</where>
		ORDER BY USER_NO DESC
	</select>
	
	<!-- 사원 상세 조회 -->
	<select id="memberDetail" resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$MemberResponse">
		SELECT
			M.USER_NO,
			M.USER_NAME,
			M.EMAIL,
			M.HIRE_DATE,
			M.PHONE,
			M.EXTENSION,
			M.ADDRESS,
			M.ADDRESS_DETAIL,
			M.UPDATE_DATE,
			M.STATUS,
			M.DEP_ID,  M.POS_ID,  D.DEP_NAME,
			P.POS_NAME
		FROM MEMBER M
		LEFT JOIN DEPARTMENT D ON D.DEP_ID = M.DEP_ID
		LEFT JOIN POSITIONS P ON P.POS_ID = M.POS_ID
		WHERE M.USER_NO = #{userNo} 
	</select>
	
	<!-- 사원 등록 -->
	<insert id="memberInsert" parameterType="com.kh.coreflow.model.dto.UserDto$User">
		INSERT INTO MEMBER (
			DEP_ID, POS_ID, EMAIL, USER_NAME, USER_PWD, PHONE, 
			ADDRESS, ADDRESS_DETAIL, EXTENSION, HIRE_DATE, UPDATE_DATE, STATUS)
		VALUES (
			#{depId}, #{posId}, #{email}, #{userName}, #{userPwd}, #{phone},
			#{address}, #{addressDetail}, #{extension}, #{hireDate}, SYSDATE, #{status}
		)
	</insert>
	
	<!-- 사원 정보 수정 -->
	<update id="memberUpdate">
		UPDATE MEMBER
		<set>
			<if test="userName != null and userName != ''">USER_NAME = #{userName},</if>
			<if test="email != null and email != ''">EMAIL = #{email},</if>
			<if test="hireDate != null">HIRE_DATE = #{hireDate},</if>
			<if test="phone != null and phone != ''">PHONE = #{phone},</if>
			<if test="extension != null and extension != ''">EXTENSION = #{extension},</if>
			<if test="address != null and address != ''">ADDRESS = #{address},</if>
			<if test="addressDetail != null and addressDetail != ''">ADDRESS_DETAIL = #{addressDetail},</if>
			<if test="depName != null and depName != ''">
				DEP_ID = (SELECT DEP_ID FROM DEPARTMENT WHERE DEP_NAME = #{depName}),
			</if>
			<if test="posName != null and posName != ''">
				POS_ID = (SELECT POS_ID FROM POSITIONS WHERE POS_NAME = #{posName}),
			</if>
			<if test="status != null and status != '' ">
				STATUS = #{status},
			</if>
			UPDATE_DATE = SYSDATE
		</set>
		WHERE USER_NO = #{userNo} AND
			  DEP_ID = #{depId}
	</update>
	
	<!-- 회원 정보 삭제 -->
	<delete id="memberDelete">
		DELETE FROM MEMBER
		WHERE USER_NO = #{userNo}
	</delete>
	
  <!-- 남건후 -->
  <select id="searchMembers" parameterType="map"
          resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$MemberLite">
    SELECT
      USER_NO    AS userNo,
      DEP_ID     AS depId,
      POS_ID     AS posId,
      USER_NAME  AS userName,
      EMAIL      AS email
    FROM MEMBER
    WHERE NVL(STATUS,'T') = 'T'
      <if test="depId != null">
        AND DEP_ID = #{depId}
      </if>
      <if test="query != null and query != ''">
        AND (
          UPPER(USER_NAME) LIKE '%' || UPPER(#{query}) || '%'
          OR UPPER(EMAIL)  LIKE '%' || UPPER(#{query}) || '%'
        )
      </if>
    ORDER BY USER_NAME ASC
    <if test="limit != null">
      FETCH FIRST #{limit} ROWS ONLY
    </if>
  </select>
  
    <select id="findAll"
          resultType="com.kh.coreflow.humanmanagement.model.dto.MemberDto$DepartmentLite">
    SELECT
      DEP_ID     AS depId,
      DEP_NAME   AS depName,
      PARENT_ID  AS parentId
    FROM DEPARTMENT
    ORDER BY DEP_NAME ASC
  </select>
</mapper>